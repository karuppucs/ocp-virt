---
- name: Build a list of all the folders
  vmware.vmware_rest.vcenter_folder_info:
  register: all_folders

- name: Filter VM folders
  ansible.builtin.set_fact:
    vm_folders: "{{ all_folders.value | selectattr('type', 'equalto', 'VIRTUAL_MACHINE') | list }}"

- name: Check each VM folder for VMs
  vmware.vmware_rest.vcenter_vm_info:
    folders: "{{ item.folder }}"
  register: vm_folders_with_vms
  loop: "{{ vm_folders }}"
  when: vm_folders | length > 0

- name: Display VM names and IDs
  ansible.builtin.debug:
    msg: "VM Name: {{ item.name }}, VM ID: {{ item.vm }}"
  loop: "{{ vm_folders_with_vms.results | map(attribute='value') | flatten }}"
  when: item | length > 0
  loop_control:
    label: "{{ item.name }}"

- name: Collect VM names and IDs
  ansible.builtin.set_fact:
    vm_name_id_pairs: "{{ vm_name_id_pairs | default([]) + [{'name': item.name, 'vm': item.vm}] }}"
  loop: "{{ vm_folders_with_vms.results | map(attribute='value') | flatten }}"
  when: item | length > 0

- name: Prepare VMs for Plan spec
  ansible.builtin.set_fact:
    vms_for_plan_spec: "{{ vms_for_plan_spec | default([]) + [{'hooks': [], 'id': vm_id.vm}] }}"
  loop: "{{ vm_name_id_pairs }}"
  loop_control:
    loop_var: vm_id
  when: vm_id.name in user_selected_vm_names.split('\n')

#- name: Get information for the distributed port group 'segment-migrating-to-ocpvirt'
#  vmware.vmware_rest.vcenter_network_info:
#    filter_types: DISTRIBUTED_PORTGROUP
#  register: my_portgroup
#
#- name: Capture the distrivuted portgroup id to make network mappings
#  ansible.builtin.set_fact:
#    portgroup_id: "{{ my_portgroup.value[0].network }}"

- name: Get distributed port groups (filter DISTRIBUTED_PORTGROUP)
  vmware.vmware_rest.vcenter_network_info:
    filter_types: DISTRIBUTED_PORTGROUP
  register: my_portgroup
  failed_when: my_portgroup is failed

- name: Debug raw portgroup result (show first item for inspection)
  ansible.builtin.debug:
    msg: >-
      found {{ my_portgroup.value | default([]) | length }} distributed portgroups.
      sample: {{ (my_portgroup.value | default([]) | first) | default({}) | to_nice_json }}
  when: my_portgroup.value is defined

- name: Ensure the portgroup list is not empty
  ansible.builtin.fail:
    msg: "No distributed portgroups found (filter_types=DISTRIBUTED_PORTGROUP)."
  when: my_portgroup.value is not defined or (my_portgroup.value | length) == 0

- name: Set desired portgroup name
  ansible.builtin.set_fact:
    desired_portgroup_name: "AppIn Network"   # <-- change to "segment-migrating-to-ocpvirt" if that's the actual name

- name: Find the portgroup item by name
  ansible.builtin.set_fact:
    matched_portgroups: "{{ my_portgroup.value | selectattr('name','equalto', desired_portgroup_name) | list }}"

- name: Fail if named portgroup not found
  ansible.builtin.fail:
    msg: "Portgroup '{{ desired_portgroup_name }}' not found in vCenter (distributed portgroups)."
  when: matched_portgroups | length == 0

- name: Capture the distributed portgroup id to make network mappings
  ansible.builtin.set_fact:
    portgroup_item: "{{ matched_portgroups[0] }}"
    portgroup_id: >-
      {{
        (matched_portgroups[0].network
         if (matched_portgroups[0] is defined and 'network' in matched_portgroups[0])
         else (matched_portgroups[0].moref
               if 'moref' in matched_portgroups[0]
               else (matched_portgroups[0].object_id
                     if 'object_id' in matched_portgroups[0] else '')) )
      }}

- name: Show captured portgroup id and item
  ansible.builtin.debug:
    msg:
      - "Selected portgroup name: {{ portgroup_item.name }}"
      - "Portgroup id field used: {{ 'network' if 'network' in portgroup_item else ('moref' if 'moref' in portgroup_item else 'object_id' if 'object_id' in portgroup_item else 'unknown') }}"
      - "Portgroup id: {{ portgroup_id }}"

- name: Create or update a NetworkMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: forklift.konveyor.io/v1beta1
      kind: NetworkMap
      metadata:
        name: "{{ networkmap_name }}"
        namespace: "{{ migration_namespace }}" # openshift-mtv
      spec:
        map:
          - destination:
              type: pod
            source:
              id: "{{ portgroup_id }}"
        provider:
          destination:
            name: host
            namespace: "{{ migration_namespace }}" # openshift-mtv
          source:
            name: vmware
            namespace:  "{{ migration_namespace }}" #openshift-mtv

- name: Build a list of all the datastores
  vmware.vmware_rest.vcenter_datastore_info:
  register: all_the_datastores

# - name: Capture the datastore id
#   set_fact:
#     datastore_id: "{{ all_the_datastores.value[0].datastore }}"

# - name: Create or update a StorageMap
#   kubernetes.core.k8s:
#     state: present
#     definition:
#       apiVersion: forklift.konveyor.io/v1beta1
#       kind: StorageMap
#       metadata:
#         name: "{{ storagemap_name }}"
#         namespace: "{{ migration_namespace }}"
#       spec:
#         map:
#           - destination:
#               storageClass: ocs-storagecluster-ceph-rbd
#             source:
#               id: "{{ datastore_id }}"
#         provider:
#           destination:
#             name: host
#             namespace: "{{ migration_namespace }}"
#           source:
#             name: vmware
#             namespace: "{{ migration_namespace }}"

- name: Get storage class information
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
  register: storage_classes

- name: Find default storage class
  set_fact:
    default_storage_class: "{{ item.metadata.name }}"
  loop: "{{ storage_classes.resources }}"
  when:
    - item.metadata.annotations is defined
    - "'storageclass.kubernetes.io/is-default-class' in item.metadata.annotations"
    - item.metadata.annotations['storageclass.kubernetes.io/is-default-class'] == 'true'

- name: Print default storage class name
  debug:
    msg: "{{ default_storage_class }}"

- name: Create or update a StorageMap
  kubernetes.core.k8s:
    namespace: "{{ migration_namespace }}"
    definition: "{{ lookup('template', 'datastore.yaml.j2' ) | from_yaml }}"
    state: present

- name: Deploy Virt Plan
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: forklift.konveyor.io/v1beta1
      kind: Plan
      metadata:
        name: "{{ plan_name }}"
        namespace: "{{ migration_namespace }}"
      spec:
        archived: false
        description: ''
        map:
          network:
            name: "{{ networkmap_name }}"
            namespace: "{{ migration_namespace }}"
          storage:
            name: "{{ storagemap_name }}"
            namespace: "{{ migration_namespace }}"
        provider:
          destination:
            name: host
            namespace: "{{ migration_namespace }}"
          source:
            name: vmware
            namespace: "{{ migration_namespace }}"
        targetNamespace: "{{ migration_target_namespace }}"
        vms: "{{ vms_for_plan_spec }}"
        warm: false

- name: Create a Migration manifest to run the Plan CR
  kubernetes.core.k8s:
    api_version: forklift.konveyor.io/v1beta1
    kind: Migration
    namespace: "{{ migration_namespace }}"
    name: "{{ plan_name }}"
    definition:
      metadata:
        name: "{{ plan_name }}"
        namespace: "{{ migration_namespace }}"
      spec:
        plan:
          name: "{{ plan_name }}"
          namespace: "{{ migration_namespace }}"
